name: Check Evidence
on:
    push:
        branches: [ master ]
    pull_request:
    workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Clone
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install CLI
      run: cargo install --git https://github.com/super-collective/collective-cli --locked -q

    - name: Validate files
      run: |
        collective check evidence
    
    - name: Check Index Links
      run: |
        collective index evidence
        git diff --exit-code || ()

        if [ -z "$(git status --porcelain)" ]; then 
            # Working directory clean
        else 
            echo "Index links are not up to date. Please run 'collective index evidence' and commit the changes."
            exit 1
        fi

    - name: Check Modified Index Links
      run: |
          collective index evidence --reindex
          
          if [ -z "$(git status --porcelain)" ]; then 
            # Working directory clean
          else 
            echo "Index links are not up to date. Please run 'collective index evidence --reindex' and commit the changes."
            exit 1
          fi
